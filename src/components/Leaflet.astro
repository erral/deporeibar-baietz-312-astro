---
export interface Props {
  latitude?: number;
  longitude?: number;
  zoom: number;
  /** the DOM ID of a <div> element */
  container: string;
  /** https://leafletjs.com/reference.html#tilelayer */
  tileLayer: string;
  /** Most tile servers require attribution. */
  attribution: string;
  containerstyle?: string;
  markers?: {
    lat: number;
    lon: number;
    title: string;
    url: string;
    status: string;
  }[];
}

const {
  latitude,
  longitude,
  zoom,
  container,
  tileLayer,
  attribution,
  containerstyle = 'height: 61.8vh',
  markers,
} = Astro.props;
---

<leaflet-map
  data-latitude={latitude}
  data-longitude={longitude}
  data-zoom={zoom}
  data-container={container}
  data-tiles={tileLayer}
  data-attribution={attribution}
  data-containerstyle={containerstyle}
  data-markers={markers ? JSON.stringify(markers) : '[]'}
>
  <div id={container} style={containerstyle}></div>
  <script>
    // Leaflet-en ikono lehenetsien irudiak zuzen kargatzeko.
    // Vite/Astro-rekin beharrezkoa da bideak eskuz konfiguratzea.
    import L from 'leaflet';
    import iconUrl from 'leaflet/dist/images/marker-icon.png';
    import iconRetinaUrl from 'leaflet/dist/images/marker-icon-2x.png';
    import shadowUrl from 'leaflet/dist/images/marker-shadow.png';

    L.Icon.Default.imagePath = ''; // Bideak eskuz kudeatuko ditugu
    L.Icon.Default.mergeOptions({
      iconUrl: iconUrl.src,
      iconRetinaUrl: iconRetinaUrl.src,
      shadowUrl: shadowUrl.src,
    });

    import 'leaflet/dist/leaflet';
    import 'leaflet/dist/leaflet.css';

    class LeafletMap extends HTMLElement {
      constructor() {
        super();

        const lat = this.dataset.latitude
          ? Number(this.dataset.latitude)
          : 43.0;
        const lon = this.dataset.longitude
          ? Number(this.dataset.longitude)
          : -2.0;

        const latlng = [lat, lon];

        var map = L.map(this.dataset.container).setView(
          latlng,
          Number(this.dataset.zoom),
        );
        L.tileLayer(this.dataset.tiles, {
          attribution: this.dataset.attribution,
        }).addTo(map);

        const markers = JSON.parse(this.dataset.markers).filter(
          (m) => m !== null,
        );
        if (markers && markers.length > 0) {
          // Tailwind klaseak egoeraren arabera.
          // Orain CSS iragazkiak erabiliko ditugu koloreak aldatzeko.
          // `hue-rotate` balioekin jolas dezakezu koloreak doitzeko.
          const statusFilters = {
            // Oharra: Leaflet-en jatorrizko kolorea urdina da (hue ~197deg).
            eginda: 'hue-rotate(-80deg) saturate(2.5) brightness(0.9)', // Berdea
            'proposatutakoa-eginda': 'hue-rotate(0deg)', // Horia
            'egin-gabe': 'hue-rotate(160deg) saturate(3) brightness(0.9)', // Gorria
            'proposatutakoa-egin-gabe':
              'hue-rotate(160deg) saturate(3) brightness(0.9)', // Gorri bizia
            default: 'hue-rotate(0deg)', // Urdina (jatorrizkoa)
          };

          // Estiloak dokumentuaren <head> atalean txertatzeko funtzioa
          const addStyle = (css) => {
            const style =
              document.getElementById('leaflet-custom-styles') ||
              document.createElement('style');
            style.id = 'leaflet-custom-styles';
            style.textContent += css;
            document.head.appendChild(style);
          };

          // Sortu ikono pertsonalizatuak
          const createIcon = (status) => {
            const filter = statusFilters[status] || statusFilters.default;
            const className = `leaflet-marker-icon-${status}`;

            // Gehitu CSS klasea behin bakarrik
            if (!document.querySelector(`.${className}`)) {
              addStyle(`.${className} { filter: ${filter}; }`);
            }

            return new L.Icon.Default({ className: className });
          };

          markers.forEach((markerData) => {
            // Koordenatuak zenbakiak direla ziurtatu
            const lat = Number(markerData.lat);
            const lon = Number(markerData.lon);

            if (isNaN(lat) || isNaN(lon)) return;

            const icon = createIcon(markerData.status);

            const marker = L.marker([lat, lon], {
              icon: icon,
            }).addTo(map);

            if (markerData.title && markerData.url) {
              marker.bindPopup(
                `<a href="${markerData.url}">${markerData.title}</a>`,
              );
            }
          });
        } else if (this.dataset.latitude && this.dataset.longitude) {
          L.marker(latlng).addTo(map);
        }
      }
    }

    window.customElements.define('leaflet-map', LeafletMap);
  </script>
</leaflet-map>
